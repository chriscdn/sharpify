import{Semaphore as t}from"@chriscdn/promise-semaphore";import e from"sharp";import{Memoize as a}from"@chriscdn/memoize";function i(){return i=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var a=arguments[e];for(var i in a)({}).hasOwnProperty.call(a,i)&&(t[i]=a[i])}return t},i.apply(null,arguments)}const r=t=>"number"==typeof t?t-t===0:"string"==typeof t&&""!==t.trim()&&(Number.isFinite?Number.isFinite(+t):isFinite(+t)),n=async t=>{try{return await e(t).resize(1,1).toBuffer(),!0}catch(t){return!1}};e.cache(!1);const o=(t,e,a)=>r(t)?Math.min(a,Math.max(e,t)):null,h=a((t,e,a)=>{const i=(t=>t*Math.PI/180)(Math.abs(a)),r=Math.sin(i),n=Math.cos(i);let o=e*r,h=t*r,s=e*r+t*n-2*o,l=e*n+t*r-2*h;const u=t/e;if(u<s/l){const t=u*l;o+=(s-t)/2,s=t}else{const t=s/u;h+=(l-t)/2,l=t}return{left:Math.round(o),top:Math.round(h),width:Math.round(s),height:Math.round(l),aspectRatio:s/l}}),s=new t,l={blur:0,brightness:1,fit:"inside",height:null,normalise:!1,rotate:0,saturation:1,width:null,withMetadata:!1,withoutEnlargement:!0},u=async(t,a,u)=>{const c=i({},l,u);try{return await s.acquire(a),await(async(t,a,i)=>{const s=o(i.blur,0,100),l=o(i.brightness,0,2),u=i.fit,c=o(i.height,0,i.height),m=i.normalise,w=o(i.rotate,-20,20),d=o(i.saturation,0,1),f=o(i.width,0,i.width),g=i.withMetadata,p=i.withoutEnlargement;let b=await e(t);g&&(b=b.withMetadata());const M=await b.metadata(),y=M.width,v=M.height;if(m&&(b=b.normalise()),r(s)&&s>0&&(b=b.blur(s)),r(d)&&d<1&&(b=b.modulate({saturation:d})),r(l)&&1!=l&&(b=b.modulate({brightness:l})),0!==w){b=b.rotate(w);const t=h(y,v,w);b=b.extract({left:t.left,top:t.top,width:t.width,height:t.height})}else b=b.rotate();if((f||c)&&(b=b.resize({width:f,height:c,fit:u,withoutEnlargement:p})),await b.toFile(a),await n(a))return a;throw new Error("Invalid target generated.")})(t,a,c)}finally{s.release(a)}};export{n as isImage,u as sharpify};
//# sourceMappingURL=sharpify.modern.js.map
