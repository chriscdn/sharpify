import{Semaphore as t}from"@chriscdn/promise-semaphore";import a from"sharp";import{Memoize as e}from"@chriscdn/memoize";function i(){return i=Object.assign?Object.assign.bind():function(t){for(var a=1;a<arguments.length;a++){var e=arguments[a];for(var i in e)({}).hasOwnProperty.call(e,i)&&(t[i]=e[i])}return t},i.apply(null,arguments)}const r=t=>"number"==typeof t?t-t==0:"string"==typeof t&&""!==t.trim()&&(Number.isFinite?Number.isFinite(+t):isFinite(+t)),n=async t=>{try{var a;const{default:e}=await import("image-type"),{minimumBytes:i}=await import("image-type"),{readChunk:r}=await import("read-chunk"),n=await r(t,{length:i}),o=await e(n);return["image/jpeg","image/png"].includes(null!=(a=null==o?void 0:o.mime)?a:"")}catch(t){return!1}};a.cache(!1);const o=(t,a,e)=>r(t)?Math.min(e,Math.max(a,t)):null,h=e((t,a,e)=>{const i=(t=>t*Math.PI/180)(Math.abs(e)),r=Math.sin(i),n=Math.cos(i);let o=a*r,h=t*r,s=a*r+t*n-2*o,l=a*n+t*r-2*h;const u=t/a;if(u<s/l){const t=u*l;o+=(s-t)/2,s=t}else{const t=s/u;h+=(l-t)/2,l=t}return{left:Math.round(o),top:Math.round(h),width:Math.round(s),height:Math.round(l),aspectRatio:s/l}}),s=new t,l={blur:0,brightness:1,fit:"inside",height:null,normalise:!1,rotate:0,saturation:1,width:null,withMetadata:!1,withoutEnlargement:!0},u=async(t,e,u)=>{const m=i({},l,u);try{return await s.acquire(e),await(async(t,e,i)=>{const s=o(i.blur,0,100),l=o(i.brightness,0,2),u=i.fit,m=o(i.height,0,i.height),c=i.normalise,d=o(i.rotate,-20,20),w=o(i.saturation,0,1),g=o(i.width,0,i.width),p=i.withMetadata,f=i.withoutEnlargement;let b=await a(t);p&&(b=b.withMetadata());const y=await b.metadata(),M=y.width,v=y.height;if(c&&(b=b.normalise()),r(s)&&s>0&&(b=b.blur(s)),r(w)&&w<1&&(b=b.modulate({saturation:w})),r(l)&&1!=l&&(b=b.modulate({brightness:l})),0!==d){b=b.rotate(d);const t=h(M,v,d);b=b.extract({left:t.left,top:t.top,width:t.width,height:t.height})}else b=b.rotate();if((g||m)&&(b=b.resize({width:g,height:m,fit:u,withoutEnlargement:f})),await b.toFile(e),await n(e))return e;throw new Error("Invalid target generated.")})(t,e,m)}finally{s.release(e)}};export{n as isImage,u as sharpify};
//# sourceMappingURL=sharpify.modern.js.map
