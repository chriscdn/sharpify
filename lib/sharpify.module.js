import{Semaphore as t}from"@chriscdn/promise-semaphore";import r from"sharp";import{Memoize as e}from"@chriscdn/memoize";function n(){return n=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var n in e)({}).hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},n.apply(null,arguments)}var i=function(t){return"number"==typeof t?t-t===0:"string"==typeof t&&""!==t.trim()&&(Number.isFinite?Number.isFinite(+t):isFinite(+t))},o=function(t){return Promise.resolve(function(){try{var e=Promise.resolve(r(t).resize(1,1).toBuffer()).then(function(){return!0})}catch(t){return!1}return e&&e.then?e.then(void 0,function(){return!1}):e}())};r.cache(!1);var a=function(t,r,e){return i(t)?Math.min(e,Math.max(r,t)):null},u=e(function(t,r,e){var n=function(t){return t*Math.PI/180}(Math.abs(e)),i=Math.sin(n),o=Math.cos(n),a=r*i,u=t*i,h=r*i+t*o-2*a,s=r*o+t*i-2*u,c=t/r;if(c<h/s){var l=c*s;a+=(h-l)/2,h=l}else{var f=h/c;u+=(s-f)/2,s=f}return{left:Math.round(a),top:Math.round(u),width:Math.round(h),height:Math.round(s),aspectRatio:h/s}}),h=new t,s={blur:0,brightness:1,fit:"inside",height:null,normalise:!1,rotate:0,saturation:1,width:null,withMetadata:!1,withoutEnlargement:!0},c=function(t,e,c){try{var l=n({},s,c);return Promise.resolve(function(n,s){try{var c=Promise.resolve(h.acquire(e)).then(function(){return Promise.resolve(function(t,e,n){try{var h=a(n.blur,0,100),s=a(n.brightness,0,2),c=n.fit,l=a(n.height,0,n.height),f=a(n.rotate,-20,20),m=a(n.saturation,0,1),d=a(n.width,0,n.width),v=n.withMetadata,g=n.withoutEnlargement;return Promise.resolve(r(t)).then(function(t){return v&&(t=t.withMetadata()),Promise.resolve(t.metadata()).then(function(r){var n=r.width,a=r.height;if(i(h)&&h>0&&(t=t.blur(h)),i(m)&&m<1&&(t=t.modulate({saturation:m})),i(s)&&1!=s&&(t=t.modulate({brightness:s})),0!==f){t=t.rotate(f);var v=u(n,a,f);t=t.extract({left:v.left,top:v.top,width:v.width,height:v.height})}else t=t.rotate();return(d||l)&&(t=t.resize({width:d,height:l,fit:c,withoutEnlargement:g})),Promise.resolve(t.toFile(e)).then(function(){return Promise.resolve(o(e)).then(function(t){if(t)return e;throw new Error("Invalid target generated.")})})})})}catch(t){return Promise.reject(t)}}(t,e,l))})}catch(t){return s(!0,t)}return c&&c.then?c.then(s.bind(null,!1),s.bind(null,!0)):s(!1,c)}(0,function(t,r){if(h.release(e),t)throw r;return r}))}catch(t){return Promise.reject(t)}};export{o as isImage,c as sharpify};
//# sourceMappingURL=sharpify.module.js.map
