import{Semaphore as t}from"@chriscdn/promise-semaphore";import e from"sharp";import{Memoize as r}from"@chriscdn/memoize";function n(){return n=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)({}).hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},n.apply(null,arguments)}var i=function(t){return"number"==typeof t?t-t===0:"string"==typeof t&&""!==t.trim()&&(Number.isFinite?Number.isFinite(+t):isFinite(+t))},o=function(t){return Promise.resolve(function(){try{var e=Promise.resolve(import("image-type")).then(function(e){var r=e.default;return Promise.resolve(import("image-type")).then(function(e){var n=e.minimumBytes;return Promise.resolve(import("read-chunk")).then(function(e){return Promise.resolve((0,e.readChunk)(t,{length:n})).then(function(t){return Promise.resolve(r(t)).then(function(t){var e;return["image/jpeg","image/png"].includes(null!=(e=null==t?void 0:t.mime)?e:"")})})})})})}catch(t){return!1}return e&&e.then?e.then(void 0,function(){return!1}):e}())};e.cache(!1);var a=function(t,e,r){return i(t)?Math.min(r,Math.max(e,t)):null},u=r(function(t,e,r){var n=function(t){return t*Math.PI/180}(Math.abs(r)),i=Math.sin(n),o=Math.cos(n),a=e*i,u=t*i,h=e*i+t*o-2*a,s=e*o+t*i-2*u,l=t/e;if(l<h/s){var m=l*s;a+=(h-m)/2,h=m}else{var c=h/l;u+=(s-c)/2,s=c}return{left:Math.round(a),top:Math.round(u),width:Math.round(h),height:Math.round(s),aspectRatio:h/s}}),h=new t,s={blur:0,brightness:1,fit:"inside",height:null,normalise:!1,rotate:0,saturation:1,width:null,withMetadata:!1,withoutEnlargement:!0},l=function(t,r,l){try{var m=n({},s,l);return Promise.resolve(function(n,s){try{var l=Promise.resolve(h.acquire(r)).then(function(){return Promise.resolve(function(t,r,n){try{var h=a(n.blur,0,100),s=a(n.brightness,0,2),l=n.fit,m=a(n.height,0,n.height),c=n.normalise,f=a(n.rotate,-20,20),v=a(n.saturation,0,1),d=a(n.width,0,n.width),g=n.withMetadata,p=n.withoutEnlargement;return Promise.resolve(e(t)).then(function(t){return g&&(t=t.withMetadata()),Promise.resolve(t.metadata()).then(function(e){var n=e.width,a=e.height;if(c&&(t=t.normalise()),i(h)&&h>0&&(t=t.blur(h)),i(v)&&v<1&&(t=t.modulate({saturation:v})),i(s)&&1!=s&&(t=t.modulate({brightness:s})),0!==f){t=t.rotate(f);var g=u(n,a,f);t=t.extract({left:g.left,top:g.top,width:g.width,height:g.height})}else t=t.rotate();return(d||m)&&(t=t.resize({width:d,height:m,fit:l,withoutEnlargement:p})),Promise.resolve(t.toFile(r)).then(function(){return Promise.resolve(o(r)).then(function(t){if(t)return r;throw new Error("Invalid target generated.")})})})})}catch(t){return Promise.reject(t)}}(t,r,m))})}catch(t){return s(!0,t)}return l&&l.then?l.then(s.bind(null,!1),s.bind(null,!0)):s(!1,l)}(0,function(t,e){if(h.release(r),t)throw e;return e}))}catch(t){return Promise.reject(t)}};export{o as isImage,l as sharpify};
//# sourceMappingURL=sharpify.module.js.map
