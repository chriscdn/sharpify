var e=require("@chriscdn/promise-semaphore"),t=require("sharp"),r=require("@chriscdn/memoize");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function i(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var o=/*#__PURE__*/n(t);function u(){return u=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)({}).hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},u.apply(null,arguments)}var a=function(e){return"number"==typeof e?e-e===0:"string"==typeof e&&""!==e.trim()&&(Number.isFinite?Number.isFinite(+e):isFinite(+e))},h=function(e){return Promise.resolve(function(){try{var t=Promise.resolve(Promise.resolve().then(function(){/*#__PURE__*/return i(require("image-type"))})).then(function(t){var r=t.default;return Promise.resolve(Promise.resolve().then(function(){/*#__PURE__*/return i(require("image-type"))})).then(function(t){var n=t.minimumBytes;return Promise.resolve(Promise.resolve().then(function(){/*#__PURE__*/return i(require("read-chunk"))})).then(function(t){return Promise.resolve((0,t.readChunk)(e,{length:n})).then(function(e){return Promise.resolve(r(e)).then(function(e){var t;return["image/jpeg","image/png"].includes(null!=(t=null==e?void 0:e.mime)?t:"")})})})})})}catch(e){return!1}return t&&t.then?t.then(void 0,function(){return!1}):t}())};o.default.cache(!1);var s=function(e,t,r){return a(e)?Math.min(r,Math.max(t,e)):null},l=r.Memoize(function(e,t,r){var n=function(e){return e*Math.PI/180}(Math.abs(r)),i=Math.sin(n),o=Math.cos(n),u=t*i,a=e*i,h=t*i+e*o-2*u,s=t*o+e*i-2*a,l=e/t;if(l<h/s){var c=l*s;u+=(h-c)/2,h=c}else{var f=h/l;a+=(s-f)/2,s=f}return{left:Math.round(u),top:Math.round(a),width:Math.round(h),height:Math.round(s),aspectRatio:h/s}}),c=new e.Semaphore,f={blur:0,brightness:1,fit:"inside",height:null,normalise:!1,rotate:0,saturation:1,width:null,withMetadata:!1,withoutEnlargement:!0};exports.isImage=h,exports.sharpify=function(e,t,r){try{var n=u({},f,r);return Promise.resolve(function(r,i){try{var u=Promise.resolve(c.acquire(t)).then(function(){return Promise.resolve(function(e,t,r){try{var n=s(r.blur,0,100),i=s(r.brightness,0,2),u=r.fit,c=s(r.height,0,r.height),f=r.normalise,m=s(r.rotate,-20,20),d=s(r.saturation,0,1),v=s(r.width,0,r.width),g=r.withMetadata,p=r.withoutEnlargement;return Promise.resolve(o.default(e)).then(function(e){return g&&(e=e.withMetadata()),Promise.resolve(e.metadata()).then(function(r){var o=r.width,s=r.height;if(f&&(e=e.normalise()),a(n)&&n>0&&(e=e.blur(n)),a(d)&&d<1&&(e=e.modulate({saturation:d})),a(i)&&1!=i&&(e=e.modulate({brightness:i})),0!==m){e=e.rotate(m);var g=l(o,s,m);e=e.extract({left:g.left,top:g.top,width:g.width,height:g.height})}else e=e.rotate();return(v||c)&&(e=e.resize({width:v,height:c,fit:u,withoutEnlargement:p})),Promise.resolve(e.toFile(t)).then(function(){return Promise.resolve(h(t)).then(function(e){if(e)return t;throw new Error("Invalid target generated.")})})})})}catch(e){return Promise.reject(e)}}(e,t,n))})}catch(e){return i(!0,e)}return u&&u.then?u.then(i.bind(null,!1),i.bind(null,!0)):i(!1,u)}(0,function(e,r){if(c.release(t),e)throw r;return r}))}catch(e){return Promise.reject(e)}};
//# sourceMappingURL=sharpify.cjs.map
