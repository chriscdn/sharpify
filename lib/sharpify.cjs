var e=require("@chriscdn/promise-semaphore"),t=require("sharp"),r=require("@chriscdn/memoize");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function i(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var o=/*#__PURE__*/n(e),u=/*#__PURE__*/n(t);function a(){return a=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},a.apply(this,arguments)}var h=function(e){return"number"==typeof e?e-e==0:"string"==typeof e&&""!==e.trim()&&(Number.isFinite?Number.isFinite(+e):isFinite(+e))},s=function(e){return Promise.resolve(function(t,r){try{var n=Promise.resolve(Promise.resolve().then(function(){/*#__PURE__*/return i(require("image-type"))})).then(function(t){var r=t.default;return Promise.resolve(Promise.resolve().then(function(){/*#__PURE__*/return i(require("image-type"))})).then(function(t){var n=t.minimumBytes;return Promise.resolve(Promise.resolve().then(function(){/*#__PURE__*/return i(require("read-chunk"))})).then(function(t){return Promise.resolve((0,t.readChunk)(e,{length:n})).then(function(e){return Promise.resolve(r(e)).then(function(e){var t;return["image/jpeg","image/png"].includes(null!=(t=null==e?void 0:e.mime)?t:"")})})})})})}catch(e){return!1}return n&&n.then?n.then(void 0,function(){return!1}):n}())};u.default.cache(!1);var l=function(e,t,r){return h(e)?Math.min(r,Math.max(t,e)):null},c=r.Memoize(function(e,t,r){var n=function(e){return e*Math.PI/180}(Math.abs(r)),i=Math.sin(n),o=Math.cos(n),u=t*i,a=e*i,h=t*i+e*o-2*u,s=t*o+e*i-2*a,l=e/t;if(l<h/s){var c=l*s;u+=(h-c)/2,h=c}else{var f=h/l;a+=(s-f)/2,s=f}return{left:Math.round(u),top:Math.round(a),width:Math.round(h),height:Math.round(s),aspectRatio:h/s}}),f=new o.default,m={blur:0,brightness:1,fit:"inside",height:null,normalise:!1,rotate:0,saturation:1,width:null,withMetadata:!1,withoutEnlargement:!0};exports.isImage=s,exports.sharpify=function(e,t,r){try{var n=a({},m,r);return Promise.resolve(function(r,i){try{var o=Promise.resolve(f.acquire(t)).then(function(){return Promise.resolve(function(e,t,r){try{var n=l(r.blur,0,100),i=l(r.brightness,0,2),o=r.fit,a=l(r.height,0,r.height),f=r.normalise,m=l(r.rotate,-20,20),d=l(r.saturation,0,1),v=l(r.width,0,r.width),g=r.withMetadata,p=r.withoutEnlargement;return Promise.resolve(u.default(e)).then(function(e){return g&&(e=e.withMetadata()),Promise.resolve(e.metadata()).then(function(r){var u=r.width,l=r.height;if(f&&(e=e.normalise()),h(n)&&n>0&&(e=e.blur(n)),h(d)&&d<1&&(e=e.modulate({saturation:d})),h(i)&&1!=i&&(e=e.modulate({brightness:i})),0!==m){e=e.rotate(m);var g=c(u,l,m);e=e.extract({left:g.left,top:g.top,width:g.width,height:g.height})}else e=e.rotate();return(v||a)&&(e=e.resize({width:v,height:a,fit:o,withoutEnlargement:p})),Promise.resolve(e.toFile(t)).then(function(){return Promise.resolve(s(t)).then(function(e){if(e)return t;throw new Error("Invalid target generated.")})})})})}catch(e){return Promise.reject(e)}}(e,t,n))})}catch(e){return i(!0,e)}return o&&o.then?o.then(i.bind(null,!1),i.bind(null,!0)):i(!1,o)}(0,function(e,r){if(f.release(t),e)throw r;return r}))}catch(e){return Promise.reject(e)}};
//# sourceMappingURL=sharpify.cjs.map
