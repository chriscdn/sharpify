var t=require("@chriscdn/promise-semaphore"),e=require("sharp"),r=require("@chriscdn/memoize");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=/*#__PURE__*/n(e);function a(){return a=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)({}).hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},a.apply(null,arguments)}var o=function(t){return"number"==typeof t?t-t===0:"string"==typeof t&&""!==t.trim()&&(Number.isFinite?Number.isFinite(+t):isFinite(+t))},u=function(t){return Promise.resolve(function(){try{var e=Promise.resolve(i.default(t).resize(1,1).toBuffer()).then(function(){return!0})}catch(t){return!1}return e&&e.then?e.then(void 0,function(){return!1}):e}())};i.default.cache(!1);var h=function(t,e,r){return o(t)?Math.min(r,Math.max(e,t)):null},s=r.Memoize(function(t,e,r){var n=function(t){return t*Math.PI/180}(Math.abs(r)),i=Math.sin(n),a=Math.cos(n),o=e*i,u=t*i,h=e*i+t*a-2*o,s=e*a+t*i-2*u,l=t/e;if(l<h/s){var c=l*s;o+=(h-c)/2,h=c}else{var f=h/l;u+=(s-f)/2,s=f}return{left:Math.round(o),top:Math.round(u),width:Math.round(h),height:Math.round(s),aspectRatio:h/s}}),l=new t.Semaphore,c={blur:0,brightness:1,fit:"inside",height:null,normalise:!1,rotate:0,saturation:1,width:null,withMetadata:!1,withoutEnlargement:!0};exports.isImage=u,exports.sharpify=function(t,e,r){try{var n=a({},c,r);return Promise.resolve(function(r,a){try{var c=Promise.resolve(l.acquire(e)).then(function(){return Promise.resolve(function(t,e,r){try{var n=h(r.blur,0,100),a=h(r.brightness,0,2),l=r.fit,c=h(r.height,0,r.height),f=r.normalise,m=h(r.rotate,-20,20),d=h(r.saturation,0,1),v=h(r.width,0,r.width),g=r.withMetadata,w=r.withoutEnlargement;return Promise.resolve(i.default(t)).then(function(t){return g&&(t=t.withMetadata()),Promise.resolve(t.metadata()).then(function(r){var i=r.width,h=r.height;if(f&&(t=t.normalise()),o(n)&&n>0&&(t=t.blur(n)),o(d)&&d<1&&(t=t.modulate({saturation:d})),o(a)&&1!=a&&(t=t.modulate({brightness:a})),0!==m){t=t.rotate(m);var g=s(i,h,m);t=t.extract({left:g.left,top:g.top,width:g.width,height:g.height})}else t=t.rotate();return(v||c)&&(t=t.resize({width:v,height:c,fit:l,withoutEnlargement:w})),Promise.resolve(t.toFile(e)).then(function(){return Promise.resolve(u(e)).then(function(t){if(t)return e;throw new Error("Invalid target generated.")})})})})}catch(t){return Promise.reject(t)}}(t,e,n))})}catch(t){return a(!0,t)}return c&&c.then?c.then(a.bind(null,!1),a.bind(null,!0)):a(!1,c)}(0,function(t,r){if(l.release(e),t)throw r;return r}))}catch(t){return Promise.reject(t)}};
//# sourceMappingURL=sharpify.cjs.map
